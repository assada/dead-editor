name: Nightly Build

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

concurrency:
  group: nightly
  cancel-in-progress: true

env:
  MESON_VERSION: '1.3.0'

jobs:
  check-changes:
    name: Check for changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes in last 24 hours
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          LAST_COMMIT_TIME=$(git log -1 --format=%ct)
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
          HOURS_DIFF=$((TIME_DIFF / 3600))

          if [ $HOURS_DIFF -lt 24 ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Changes detected in last 24 hours, building..."
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No changes in last 24 hours, skipping build"
          fi

  build-linux:
    name: Build Linux Nightly
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    container: ubuntu:24.04
    steps:
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            git \
            ca-certificates \
            build-essential \
            pkg-config \
            python3 \
            python3-pip \
            ninja-build \
            libsdl2-dev \
            libsdl2-ttf-dev \
            libtree-sitter-dev \
            ffmpeg \
            file \
            wget \
            fuse \
            libfuse2

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Meson
        run: pip3 install meson==${{ env.MESON_VERSION }} --break-system-packages

      - name: Get version info
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          echo "version=nightly-${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Configure
        run: meson setup build --buildtype=release --prefix=/usr --strip

      - name: Build
        run: meson compile -C build

      - name: Create tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DESTDIR="$PWD/DeadEditor-${VERSION}-linux-x86_64" meson install -C build
          tar czvf "DeadEditor-${VERSION}-linux-x86_64.tar.gz" "DeadEditor-${VERSION}-linux-x86_64"

      - name: Create AppImage
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          chmod +x linuxdeploy-x86_64.AppImage

          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps AppDir/usr/share/DeadEditor
          cp build/DeadEditor AppDir/usr/bin/
          cp packaging/linux/DeadEditor.desktop AppDir/usr/share/applications/
          cp icon.png AppDir/usr/share/icons/hicolor/256x256/apps/deadedit.png
          cp JetBrainsMonoNLNerdFont-Regular.ttf AppDir/usr/share/DeadEditor/
          cp icon.png AppDir/deadedit.png
          cp packaging/linux/DeadEditor.desktop AppDir/

          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage || true

          if [ -f DeadEditor*.AppImage ]; then
            mv DeadEditor*.AppImage "DeadEditor-${VERSION}-linux-x86_64.AppImage"
          fi

      - name: Generate checksums
        run: |
          sha256sum DeadEditor-*.tar.gz DeadEditor-*.AppImage 2>/dev/null > SHA256SUMS-linux.txt || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-linux
          path: |
            DeadEditor-*.tar.gz
            DeadEditor-*.AppImage
            SHA256SUMS-linux.txt
          retention-days: 7

  build-macos-intel:
    name: Build macOS Intel Nightly
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          echo "version=nightly-${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          brew update
          brew install meson ninja pkg-config sdl2 sdl2_ttf tree-sitter ffmpeg create-dmg

      - name: Configure
        run: meson setup build --buildtype=release

      - name: Build
        run: meson compile -C build

      - name: Build DMG
        run: meson compile -C build dmg

      - name: Rename artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mv build/*.dmg "DeadEditor-${VERSION}-macos-x86_64.dmg"
          ditto -c -k --keepParent build/DeadEditor.app "DeadEditor-${VERSION}-macos-x86_64.zip"

      - name: Generate checksums
        run: sha256sum DeadEditor-*.dmg DeadEditor-*.zip > SHA256SUMS-macos-intel.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-macos-intel
          path: |
            DeadEditor-*.dmg
            DeadEditor-*.zip
            SHA256SUMS-macos-intel.txt
          retention-days: 7

  build-macos-arm:
    name: Build macOS ARM Nightly
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          echo "version=nightly-${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          brew update
          brew install meson ninja pkg-config sdl2 sdl2_ttf tree-sitter ffmpeg create-dmg

      - name: Configure
        run: meson setup build --buildtype=release

      - name: Build
        run: meson compile -C build

      - name: Build DMG
        run: meson compile -C build dmg

      - name: Rename artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mv build/*.dmg "DeadEditor-${VERSION}-macos-arm64.dmg"
          ditto -c -k --keepParent build/DeadEditor.app "DeadEditor-${VERSION}-macos-arm64.zip"

      - name: Generate checksums
        run: sha256sum DeadEditor-*.dmg DeadEditor-*.zip > SHA256SUMS-macos-arm.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-macos-arm
          path: |
            DeadEditor-*.dmg
            DeadEditor-*.zip
            SHA256SUMS-macos-arm.txt
          retention-days: 7

  update-nightly-release:
    name: Update Nightly Release
    needs: [check-changes, build-linux, build-macos-intel, build-macos-arm]
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize artifacts
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" \) -exec cp {} release/ \;

          cat artifacts/*/SHA256SUMS*.txt > release/SHA256SUMS.txt
          ls -la release/

      - name: Delete existing nightly release
        run: |
          gh release delete nightly --yes || true
          git push origin :refs/tags/nightly || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build"
          body: |
            ## Nightly Build

            **⚠️ This is an automated nightly build and may be unstable.**

            Built from commit: ${{ github.sha }}
            Build date: ${{ github.event.repository.updated_at }}

            ### Downloads

            See assets below. Each platform has:
            - Main distribution file (`.tar.gz`, `.dmg`, `.AppImage`)
            - ZIP archive with app bundle (macOS only)

            ### Verification

            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
          draft: false
          prerelease: true
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-failure:
    name: Notify on Failure
    needs: [build-linux, build-macos-intel, build-macos-arm]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly build failed on ${new Date().toISOString().split('T')[0]}`;
            const body = `
            The nightly build has failed.

            **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            **Commit:** ${context.sha}

            Please investigate and fix the issue.
            `;

            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'nightly-failure',
              state: 'open'
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['nightly-failure', 'bug', 'ci']
              });
            }
